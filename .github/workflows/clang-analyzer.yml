name: Clang Static Analyzer
on:
  workflow_dispatch:
  push:
    branches: [ master, "release/**" ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read

jobs:
  Analyze:
    runs-on: ubuntu-latest

    permissions:
      # Needed to upload the results to code-scanning dashboard.
      security-events: write
      contents: read

    steps:
      - name: Setup
        run: |
          echo "set man-db/auto-update false" | sudo debconf-communicate && sudo dpkg-reconfigure man-db
          sudo apt-get -qq update
          sudo apt-get -qq install -y ninja-build clang-tools

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          submodules: true

      - name: Configure & Build
        run: |
          LLVM_VER=`clang --version | head -n1 | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+' | cut -d. -f1`
          echo "Using LLVM version $LLVM_VER"

          mkdir build
          cd build

          scan-build-py-$LLVM_VER cmake -G Ninja -DPCRE2_SUPPORT_JIT=ON -DCMAKE_BUILD_TYPE=Debug ..
          scan-build-py-$LLVM_VER -o clang-sarif-root/ --sarif-html ninja
          rm clang-sarif-root/*/result-*.sarif
          mv clang-sarif-root/* ../clang-report

          ../.github/scripts/merge_sarif.py ../clang-report/results-merged.sarif

      # Upload the browsable HTML report as an artifact.
      - name: Upload report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: "Clang Static Analyzer report"
          path: './clang-report'

      # Upload the results to GitHub's code scanning dashboard.
      - name: "Upload to code-scanning"
        uses: github/codeql-action/upload-sarif@3599b3baa15b485a2e49ef411a7a4bb2452e7f93 # v3.29.5
        with:
          sarif_file: ./clang-report/results-merged.sarif
          category: clang-analyzer
